@using invMed.Data
@inject AdminService adminService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudPaper Style="min-height: 640px" Elevation="2">
            <MudContainer Style="text-align: center" MaxWidth="MaxWidth.ExtraSmall">
                @if (model is not null)
                {
                    <MudAvatar Class="mt-12" Size="Size.Large" Color="Color.Secondary">@model.Name[0]@model.Surname[0]</MudAvatar>
                    <MudText Class="mt-4">@model.Name @model.Surname</MudText>
                    <MudText>@role</MudText>
                    <EditForm Model="@model" OnValidSubmit="OnValidSubmit">
                        <DataAnnotationsValidator />
                        <MudTextField Class="mt-6" Label="Id" Disabled="true" @bind-Value="model.Id" For="@(() => model.Id)" />
                        <MudTextField Class="mt-4" Label="Name" @bind-Value="model.Name" For="@(() => model.Name)" />
                        <MudTextField Class="mt-4" Label="Surname" @bind-Value="model.Surname" For="@(() => model.Surname)" />
                        <MudTextField Class="mt-4" Label="User name" @bind-Value="model.UserName" For="@(() => model.UserName)" />
                        <MudTextField Class="mt-4" Label="Email" @bind-Value="model.Email" For="@(() => model.Email)" />
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4">Save</MudButton>
                    </EditForm>
                }
                else
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
                }
            </MudContainer>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>


@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public string userId { get; set; }
    [Parameter] public string role { get; set; }
    private AspNetUser model;

    void Submit() => MudDialog.Close(DialogResult.Ok(true));

    private async void OnValidSubmit()
    {
        var result = await adminService.UpdateUser(model);
        if (result)
        {
            Snackbar.Add("Success, changes saved", Severity.Success);
        }
        else
        {
            Snackbar.Add("Error, changes not changed", Severity.Error);
        }
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        model = await Task.Run(() => adminService.GetUserById(userId));
    }
}
